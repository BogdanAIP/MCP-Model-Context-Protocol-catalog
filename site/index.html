<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MCP Catalog</title>
<style>
:root{--bg:#0b0f14;--card:#10161f;--ink:#e8eef6;--muted:#99a7b3;--brand:#5aa7ff;--chip:#1a2330}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui}
main{max-width:1100px;margin:24px auto;padding:0 16px 40px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
h1{margin:0;font-size:24px}
.controls{display:flex;gap:8px;align-items:center}
input[type=search]{width:360px;max-width:60vw;background:#0f1520;border:1px solid #223044;color:var(--ink);border-radius:10px;padding:8px 10px}
.lang button,.chip{background:var(--chip);border:1px solid #223044;color:var(--ink);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
.lang button.active,.chip.active{outline:2px solid var(--brand)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
.card{background:var(--card);border:1px solid #223044;border-radius:14px;padding:12px}
.card h3{margin:0 0 6px 0}
.meta{color:var(--muted);font-size:12px;margin-bottom:6px}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{font-size:11px;border:1px solid #27415a;background:#14202e;border-radius:999px;padding:3px 7px}
.links a{color:var(--brand);margin-right:10px;text-decoration:none}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.footer{margin-top:16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<main>
  <header>
    <h1 id="title">MCP Catalog</h1>
    <div class="controls">
      <input id="q" type="search" placeholder="Search servers (title, keywords, description)…" />
      <div class="lang">
        <button id="b-en" class="active">EN</button>
        <button id="b-ru">RU</button>
      </div>
    </div>
  </header>

  <div class="toolbar" id="cats"></div>
  <div class="grid" id="list"></div>
  <div class="footer" id="foot"></div>
</main>

<script>
const UI = {
  en: {
    title: "MCP Catalog",
    search: "Search servers (title, keywords, description)…",
    all: "all",
    count: (n, tot) => `${n} / ${tot}`,
    manifest: "manifest",
    homepage: "homepage",
    repo: "repo"
  },
  ru: {
    title: "MCP Каталог",
    search: "Поиск серверов (название, ключевые слова, описание)…",
    all: "все",
    count: (n, tot) => `Показано ${n} из ${tot}`,
    manifest: "манифест",
    homepage: "сайт",
    repo: "репозиторий"
  }
};
const CATS = ["all","ai","devtools","messaging","productivity","storage","other"];
let LANG = (new URL(location.href).searchParams.get("lang") || localStorage.getItem("LANG") || "en");
if(!UI[LANG]) LANG = "en";
const els = { q: document.getElementById("q"), list: document.getElementById("list"), cats: document.getElementById("cats"), title: document.getElementById("title"), foot: document.getElementById("foot") };

function t(k,...a){ const s = UI[LANG][k]; return typeof s === "function" ? s(...a) : s; }
function pickText(field){
  if (!field) return "";
  if (typeof field === "string") return field;
  if (typeof field === "object") return field[LANG] || field.en || Object.values(field).find(v=>typeof v==="string") || "";
  return "";
}
function pickKeywords(field){
  if (Array.isArray(field)) return field.map(String);
  if (field && typeof field === "object") {
    if (Array.isArray(field[LANG])) return field[LANG].map(String);
    if (Array.isArray(field.en)) return field.en.map(String);
    for (const v of Object.values(field)) if (Array.isArray(v)) return v.map(String);
  }
  return [];
}
function setLang(newLang){
  LANG = newLang; localStorage.setItem("LANG", LANG);
  document.getElementById("b-en").classList.toggle("active", LANG==="en");
  document.getElementById("b-ru").classList.toggle("active", LANG==="ru");
  els.title.textContent = t("title");
  els.q.placeholder = t("search");
  render();
}
document.getElementById("b-en").onclick = ()=>setLang("en");
document.getElementById("b-ru").onclick = ()=>setLang("ru");

let ALL = [], FILTER_CAT="all", QUERY="";
function render(){
  const tot = ALL.length;
  const q = QUERY.trim().toLowerCase();
  const items = ALL.filter(it=>{
    if (FILTER_CAT!=="all" && it.category!==FILTER_CAT) return false;
    if (!q) return true;
    const s = (it.title+" "+it.desc+" "+(it.keywords||[]).join(" ")).toLowerCase();
    return s.includes(q);
  });
  els.cats.innerHTML = CATS.map(c=>{
    const lbl = c==="all" ? t("all") : c;
    return `<button class="chip ${FILTER_CAT===c?'active':''}" data-cat="${c}">${lbl}</button>`;
  }).join("");
  for (const b of els.cats.querySelectorAll(".chip")) b.onclick = ()=>{ FILTER_CAT=b.dataset.cat; render(); };

  els.list.innerHTML = items.map(s=>`
    <div class="card">
      <div class="meta">${s.category}</div>
      <h3>${s.title}</h3>
      <div class="meta">${s.badges.map(b=>`<span class="badge">${b}</span>`).join(" ")}</div>
      <div>${s.desc || ""}</div>
      <div class="links" style="margin-top:8px">
        <a href="../${s.path}" target="_blank">${t("manifest")}</a>
        ${s.homepage?`<a href="${s.homepage}" target="_blank">${t("homepage")}</a>`:""}
        ${s.repo?`<a href="${s.repo}" target="_blank">${t("repo")}</a>`:""}
      </div>
    </div>
  `).join("");
  els.foot.textContent = t("count")(items.length, tot);
}
els.q.addEventListener("input", e=>{ QUERY=e.target.value; render(); });

async function safeJson(url){
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok) throw new Error("HTTP "+res.status+" @ "+url);
  return res.json();
}

async function load(){
  try{
    const idx = await safeJson("../registry/servers.index.json?v="+Date.now());
    const arr = [];
    for (const it of idx){
      try{
        const m = await safeJson("../"+it.path+"?v="+Date.now());
        const meta = m.meta || {};
        arr.push({
          name: m.name || it.name,
          path: it.path,
          category: (meta.category || it.category || "other"),
          title: pickText(meta.title) || it.name,
          desc: pickText(meta.description) || "",
          keywords: pickKeywords(meta.keywords),
          homepage: meta.homepage || it.homepage || "",
          repo: meta.repo || "",
          badges: (meta.badges || it.badges || [])
        });
      }catch(e){ console.warn("manifest fail", it, e); }
    }
    ALL = arr;
    render();
  }catch(e){
    els.list.innerHTML = `<div class="card"><b>Load error</b><div class="meta">${String(e)}</div></div>`;
  }
}
setLang(LANG);
load();
</script>
</body>
</html>
