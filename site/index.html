<!doctype html>
<html lang="en" translate="no" class="notranslate">
<head>
  <meta charset="utf-8" />
  <title>MCP Catalog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google" content="notranslate" />
  <style>
    :root{--bg:#0b0f14;--card:#10161f;--ink:#e8eef6;--muted:#99a7b3;--brand:#5aa7ff;--chip:#1a2330;--ok:#27c93f;--warn:#ffb020}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell}
    header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg) 70%,transparent);padding:18px 16px 8px;z-index:10}
    .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;max-width:1100px;margin:0 auto}
    .title{font-size:20px;font-weight:700;margin-right:auto;white-space:nowrap}
    .lang{display:flex;gap:6px}
    .lang button{background:var(--chip);border:1px solid #223044;color:var(--ink);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .lang button.active{outline:2px solid var(--brand)}
    input[type="search"]{flex:1;min-width:220px;background:var(--card);border:1px solid #223044;color:var(--ink);border-radius:10px;padding:10px 12px;outline:none}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #223044;color:var(--ink);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .chip.active{outline:2px solid var(--brand)}
    .count{color:var(--muted);font-size:13px}
    main{max-width:1100px;margin:14px auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid #223044;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0 0 4px 0;font-size:18px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #27415a;background:#14202e}
    .badge.verified{border-color:var(--ok);color:#c7ffd8;background:#13241a}
    .badge.community{border-color:var(--warn);background:#2a210f}
    .links{display:flex;gap:10px;flex-wrap:wrap}
    .links a{font-size:13px;color:var(--brand);text-decoration:none}
    .empty{color:var(--muted);text-align:center;padding:32px}
    footer{max-width:1100px;margin:0 auto;padding:18px 16px;color:var(--muted);font-size:13px}
    .pill{padding:2px 8px;border-radius:999px;background:#182435;border:1px solid #223044;font-size:12px}
  </style>
</head>
<body class="notranslate">
  <header>
    <div class="bar">
      <div class="title"><span class="notranslate">MCP</span> <span id="title-text">Catalog</span></div>
      <input id="q" type="search" placeholder="Search servers (title, keywords, description)…" />
      <div id="chips" class="chips"></div>
      <div id="count" class="count"></div>
      <div class="lang">
        <button id="lang-en" class="active">EN</button>
        <button id="lang-ru">RU</button>
      </div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>Loading…</div>
  </main>

  <footer>
    <span class="pill">UI</span> loads <code>registry/servers.index.json</code> and each server manifest’s <code>meta</code>. |
    <a href="../registry/servers.index.json">Registry JSON</a> ·
    <a href="../servers/">Servers</a> ·
    <a href="../schema/">Schema</a> ·
    <a href="../README.md">README</a>
  </footer>

  <script>
  (function(){
    // ——— i18n UI strings ———
    const STR = {
      en: {
        title: 'Catalog',
        searchPh: 'Search servers (title, keywords, description)…',
        all: 'all',
        shown: (a,b)=>`${a} / ${b}`,
        manifest: 'manifest',
        homepage: 'homepage',
        repo: 'repo',
        nothing: 'Nothing found. Try another query or clear filters.',
        loading: 'Loading…'
      },
      ru: {
        title: 'Каталог',
        searchPh: 'Поиск серверов (название, ключевые слова, описание)…',
        all: 'все',
        shown: (a,b)=>`Показано ${a} из ${b}`,
        manifest: 'манифест',
        homepage: 'сайт',
        repo: 'репозиторий',
        nothing: 'Ничего не найдено. Измените запрос или очистите фильтры.',
        loading: 'Загрузка…'
      }
    };

    // detect lang from URL
    const params = new URLSearchParams(location.search);
    let LANG = (params.get('lang')||'en').toLowerCase();
    if (!['en','ru'].includes(LANG)) LANG='en';

    // DOM refs
    const els = {
      titleText: document.getElementById('title-text'),
      q: document.getElementById('q'),
      chips: document.getElementById('chips'),
      grid: document.getElementById('grid'),
      empty: document.getElementById('empty'),
      count: document.getElementById('count'),
      en: document.getElementById('lang-en'),
      ru: document.getElementById('lang-ru'),
    };

    // helpers
    const escapeHTML = s => (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    function pickText(field) {
      if (typeof field === 'string') return field;
      if (field && typeof field === 'object') {
        return field[LANG] || field.en || Object.values(field).find(v=>typeof v==='string') || '';
      }
      return '';
    }
    function pickKeywords(field) {
      if (Array.isArray(field)) return field.map(String);
      if (field && typeof field === 'object') {
        return (field[LANG] || field.en || Object.values(field).find(v=>Array.isArray(v)) || []).map(String);
      }
      return [];
    }

    // state
    const state = { q:'', cat:'all', items:[], cats:[] };

    // base URLs + cache bust
    const BASE = location.pathname.replace(/\/site\/.*$/, '/');
    const REGISTRY_URL = BASE + 'registry/servers.index.json?v=' + Date.now();

    // language wiring
    function applyLang(){
      document.documentElement.lang = LANG;
      els.titleText.textContent = STR[LANG].title;
      els.q.placeholder = STR[LANG].searchPh;
      els.en.classList.toggle('active', LANG==='en');
      els.ru.classList.toggle('active', LANG==='ru');
      if (state.items.length===0) {
        els.empty.hidden = false;
        els.empty.textContent = STR[LANG].loading;
      } else {
        render();
      }
    }
    function setLang(l){
      LANG=l;
      const p = new URLSearchParams(location.search);
      p.set('lang', l);
      history.replaceState(null,'',location.pathname + '?' + p.toString());
      applyLang();
    }
    els.en.addEventListener('click', ()=>setLang('en'));
    els.ru.addEventListener('click', ()=>setLang('ru'));

    // filters
    function renderFilters(){
      els.chips.innerHTML='';
      state.cats.forEach(cat=>{
        const b = document.createElement('button');
        b.className = 'chip' + (state.cat===cat ? ' active' : '');
        b.textContent = (cat==='all' ? STR[LANG].all : cat);
        b.onclick = ()=>{ state.cat=cat; render(); writeParams(); };
        els.chips.appendChild(b);
      });
      els.q.oninput = e => { state.q = e.target.value.trim().toLowerCase(); render(); writeParams(); };
    }
    function writeParams(){
      const p = new URLSearchParams(location.search);
      p.set('lang', LANG);
      if (state.cat!=='all') p.set('cat', state.cat); else p.delete('cat');
      if (state.q) p.set('q', state.q); else p.delete('q');
      history.replaceState(null,'',location.pathname + (p.toString()?('?'+p.toString()):''));
    }
    function readParams(){
      const p = new URLSearchParams(location.search);
      const cat = p.get('cat'); const q = p.get('q');
      if (cat) state.cat = cat;
      if (q) { state.q = q; els.q.value = q; }
    }

    function filterItems(){
      return state.items.filter(x=>{
        const byCat = state.cat==='all' || x.category===state.cat;
        if (!state.q) return byCat;
        const hay = (x.title+' '+x.description+' '+(x.keywords||'')+' '+x.name).toLowerCase();
        return byCat && hay.includes(state.q);
      });
    }

    function render(){
      const T=STR[LANG];
      const items = filterItems();
      els.count.textContent = T.shown(items.length, state.items.length);
      els.grid.innerHTML='';
      els.empty.hidden = items.length!==0;
      if (items.length===0) els.empty.textContent = T.nothing;

      for (const x of items){
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <h3 class="notranslate">${escapeHTML(x.title)}</h3>
          <div class="meta">
            <span>${escapeHTML(x.category)}</span><span>•</span>
            <a class="links" href="../${encodeURI(x.path)}" target="_blank" rel="noopener">${escapeHTML(T.manifest)}</a>
          </div>
          <div>${escapeHTML(x.description||'')}</div>
          <div class="badges">${(Array.isArray(x.badges)?x.badges:[]).map(b=>`<span class="badge ${b} notranslate">${escapeHTML(b)}</span>`).join('')}</div>
          <div class="links">
            ${x.homepage?`<a class="notranslate" href="${escapeHTML(x.homepage)}" target="_blank" rel="noopener">${escapeHTML(T.homepage)}</a>`:''}
            ${x.repo?`<a class="notranslate" href="${escapeHTML(x.repo)}" target="_blank" rel="noopener">${escapeHTML(T.repo)}</a>`:''}
          </div>`;
        els.grid.appendChild(card);
      }
    }

    async function loadRegistry(){
      try{
        const res = await fetch(REGISTRY_URL, {cache:'no-store'});
        if (!res.ok) throw new Error('registry http '+res.status);
        const index = await res.json();

        state.cats = ['all', ...Array.from(new Set(index.map(x=>x.category))).sort()];

        state.items = await Promise.all(index.map(async item=>{
          const url = BASE + item.path + '?v=' + Date.now();
          try{
            const r = await fetch(url, {cache:'no-store'});
            const manifest = r.ok ? await r.json() : {};
            const meta = manifest.meta || {};
            return {
              name: item.name,
              category: item.category,
              path: item.path,
              homepage: item.homepage || meta.homepage || '',
              repo: meta.repo || '',
              title: pickText(meta.title) || item.name,
              description: pickText(meta.description) || '',
              badges: Array.isArray(meta.badges)?meta.badges:[],
              keywords: pickKeywords(meta.keywords).join(' ')
            };
          }catch(e){
            return { name:item.name, category:item.category, path:item.path, title:item.name, description:'', badges:[], keywords:'' };
          }
        }));

        renderFilters();
        readParams();
        render();
      }catch(e){
        console.error(e);
        els.empty.hidden=false;
        els.empty.textContent = (LANG==='ru' ? 'Не удалось загрузить реестр.' : 'Failed to load registry.');
      }
    }

    // init
    applyLang();
    loadRegistry();
  })();
  </script>
</body>
</html>
