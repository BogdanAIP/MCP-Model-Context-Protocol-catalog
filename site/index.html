<!doctype html>
<html lang="en" translate="no" class="notranslate">
<head>
  <meta charset="utf-8" />
  <title>MCP Catalog · Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- запрет автоперевода браузерами -->
  <meta name="google" content="notranslate">
  <style>
    :root{--bg:#0b0f14;--card:#10161f;--ink:#e8eef6;--muted:#99a7b3;--brand:#5aa7ff;--chip:#1a2330;--ok:#27c93f;--warn:#ffb020}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell}
    header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg) 70%,transparent);padding:18px 16px 8px;z-index:10}
    .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;max-width:1100px;margin:0 auto}
    .title{font-size:20px;font-weight:700;margin-right:auto;white-space:nowrap}
    .lang{display:flex;gap:6px}
    .lang button{background:var(--chip);border:1px solid #223044;color:var(--ink);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .lang button.active{outline:2px solid var(--brand)}
    input[type="search"]{flex:1;min-width:220px;background:var(--card);border:1px solid #223044;color:var(--ink);border-radius:10px;padding:10px 12px;outline:none}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #223044;color:var(--ink);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .chip.active{outline:2px solid var(--brand)}
    .count{color:var(--muted);font-size:13px}
    main{max-width:1100px;margin:14px auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid #223044;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0 0 4px 0;font-size:18px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #27415a;background:#14202e}
    .badge.verified{border-color:var(--ok);color:#c7ffd8;background:#13241a}
    .badge.community{border-color:var(--warn);background:#2a210f}
    .links{display:flex;gap:10px;flex-wrap:wrap}
    .links a{font-size:13px;color:var(--brand);text-decoration:none}
    .empty{color:var(--muted);text-align:center;padding:32px}
    footer{max-width:1100px;margin:0 auto;padding:18px 16px;color:var(--muted);font-size:13px}
    .pill{padding:2px 8px;border-radius:999px;background:#182435;border:1px solid #223044;font-size:12px}
    .notranslate{unicode-bidi: plaintext;}
  </style>
</head>
<body class="notranslate">
  <header>
    <div class="bar">
      <div class="title"><span class="notranslate">MCP</span> Catalog</div>
      <input id="q" type="search" placeholder="Search servers (title, keywords, description)…" />
      <div id="chips" class="chips"></div>
      <div id="count" class="count"></div>
      <div class="lang">
        <button id="lang-en" class="active">EN</button>
        <button id="lang-ru">RU</button>
      </div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>Nothing found. Try another query or clear filters.</div>
  </main>

  <footer>
    <span class="pill">UI</span> loads <code>registry/servers.index.json</code> and each server manifest’s <code>meta</code>. |
    <a href="../registry/servers.index.json">Registry JSON</a> ·
    <a href="../servers/">Servers</a> ·
    <a href="../schema/">Schema</a> ·
    <a href="../README.md">README</a>
  </footer>

  <script>
    // --- i18n strings (EN/RU) ---
    const STR = {
      en: {
        title: 'MCP Catalog',
        searchPh: 'Search servers (title, keywords, description)…',
        all: 'all',
        shown: (a,b)=>`${a} / ${b}`,
        manifest: 'manifest',
        homepage: 'homepage',
        repo: 'repo',
        nothing: 'Nothing found. Try another query or clear filters.',
        footer: { ui: 'UI', registry: 'Registry JSON', servers: 'Servers', schema: 'Schema' }
      },
      ru: {
        title: 'Каталог MCP',
        searchPh: 'Поиск серверов (название, ключевые слова, описание)…',
        all: 'все',
        shown: (a,b)=>`Показано ${a} из ${b}`,
        manifest: 'манифест',
        homepage: 'сайт',
        repo: 'репозиторий',
        nothing: 'Ничего не найдено. Измените запрос или очистите фильтры.',
        footer: { ui: 'UI', registry: 'Реестр JSON', servers: 'Серверы', schema: 'Схема' }
      }
    };

    // persist lang in URL (?lang=en|ru)
    const urlParams = new URLSearchParams(location.search);
    let LANG = (urlParams.get('lang')||'en').toLowerCase();
    if (!['en','ru'].includes(LANG)) LANG='en';

    const els = {
      title: document.querySelector('.title'),
      q: document.getElementById('q'),
      chips: document.getElementById('chips'),
      grid: document.getElementById('grid'),
      empty: document.getElementById('empty'),
      count: document.getElementById('count'),
      langEn: document.getElementById('lang-en'),
      langRu: document.getElementById('lang-ru'),
      footer: document.querySelector('footer')
    };

    function setLang(l){
      LANG=l;
      const p=new URLSearchParams(location.search);
      p.set('lang', l);
      history.replaceState(null,'',location.pathname+'?'+p.toString());
      renderStaticText();
      render(); // re-render cards with localized labels
      els.langEn.classList.toggle('active', l==='en');
      els.langRu.classList.toggle('active', l==='ru');
      document.documentElement.lang = l;
    }

    els.langEn.onclick=()=>setLang('en');
    els.langRu.onclick=()=>setLang('ru');

    const escapeHTML = s => (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    const BASE = location.pathname.replace(/\/site\/.*$/, '/');
    const REGISTRY_URL = BASE + 'registry/servers.index.json';
    const state = { q:'', cat:'all', items:[], cats:[] };

    function renderStaticText(){
      const T=STR[LANG];
      els.title.innerHTML = `<span class="notranslate">MCP</span> ${escapeHTML(T.title.replace(/^Каталог MCP$/,'Каталог MCP'))}`;
      els.q.placeholder = T.searchPh;
      // footer links (labels only)
      els.footer.innerHTML =
        `<span class="pill">UI</span> ${LANG==='ru'?'загружает':'loads'} <code>registry/servers.index.json</code> ${LANG==='ru'?'и':''} ${LANG==='ru'?'meta каждого манифеста':'and each server manifest’s <code>meta</code>'}. |
         <a href="../registry/servers.index.json">${STR[LANG].footer.registry}</a> ·
         <a href="../servers/">${STR[LANG].footer.servers}</a> ·
         <a href="../schema/">${STR[LANG].footer.schema}</a> ·
         <a href="../README.md">README</a>`;
      document.getElementById('empty').textContent = STR[LANG].nothing;
    }

    function readQueryParams() {
      const p = new URLSearchParams(location.search);
      const cat = p.get('cat'); const q = p.get('q');
      if (cat) state.cat = cat;
      if (q) { state.q = q; els.q.value = q; }
    }
    function writeQueryParams() {
      const p = new URLSearchParams(location.search);
      p.set('lang', LANG);
      if (state.cat && state.cat!=='all') p.set('cat', state.cat); else p.delete('cat');
      if (state.q) p.set('q', state.q); else p.delete('q');
      history.replaceState(null,'',location.pathname+(p.toString()?('?'+p.toString()):''));
    }

    function renderFilters() {
      els.chips.innerHTML = '';
      const cats = state.cats;
      cats.forEach(cat => {
        const b = document.createElement('button');
        b.className = 'chip' + (state.cat===cat ? ' active' : '');
        b.textContent = (cat==='all' ? STR[LANG].all : cat);
        b.onclick = () => { state.cat = cat; writeQueryParams(); render(); };
        els.chips.appendChild(b);
      });
      els.q.oninput = (e) => { state.q = e.target.value.trim().toLowerCase(); writeQueryParams(); render(); };
    }

    function filterItems() {
      return state.items.filter(x => {
        const byCat = state.cat==='all' || x.category===state.cat;
        if (!state.q) return byCat;
        const hay = (x.title+' '+x.description+' '+(x.keywords||'')+' '+x.name).toLowerCase();
        return byCat && hay.includes(state.q);
      });
    }

    function render() {
      const T=STR[LANG];
      const items = filterItems();
      els.count.textContent = T.shown(items.length, state.items.length);
      els.grid.innerHTML = '';
      els.empty.hidden = items.length !== 0;

      for (const x of items) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3 class="notranslate">${escapeHTML(x.title)}</h3>
          <div class="meta">
            <span>${escapeHTML(x.category)}</span>
            <span>•</span>
            <a class="links" href="../${encodeURI(x.path)}" target="_blank" rel="noopener">${escapeHTML(T.manifest)}</a>
          </div>
          <div>${escapeHTML(x.description || '')}</div>
          <div class="badges">
            ${(Array.isArray(x.badges)?x.badges:[]).map(b => `<span class="badge ${b} notranslate">${escapeHTML(b)}</span>`).join('')}
          </div>
          <div class="links">
            ${x.homepage ? `<a class="notranslate" href="${escapeHTML(x.homepage)}" target="_blank" rel="noopener">${escapeHTML(T.homepage)}</a>` : ''}
            ${x.repo ? `<a class="notranslate" href="${escapeHTML(x.repo)}" target="_blank" rel="noopener">${escapeHTML(T.repo)}</a>` : ''}
          </div>
        `;
        els.grid.appendChild(card);
      }
    }

    async function loadRegistry() {
      const res = await fetch(REGISTRY_URL, {cache:'no-store'});
      const index = await res.json();

      // categories from index
      state.cats = ['all', ...Array.from(new Set(index.map(x => x.category))).sort()];

      // minimal meta fetch
      state.items = await Promise.all(index.map(async item => {
        const url = BASE + item.path;
        try {
          const r = await fetch(url, {cache:'no-store'});
          const manifest = r.ok ? await r.json() : {};
          const meta = manifest.meta || {};
          return {
            name: item.name,
            category: item.category,
            path: item.path,
            homepage: item.homepage || meta.homepage || '',
            repo: meta.repo || '',
            title: meta.title || item.name,
            description: meta.description || '',
            badges: Array.isArray(meta.badges) ? meta.badges : [],
            keywords: (meta.keywords || []).map(String).join(' ')
          };
        } catch {
          return { name:item.name, category:item.category, path:item.path, title:item.name, description:'', badges:[], keywords:'' };
        }
      }));

      renderStaticText();
      renderFilters();
      readQueryParams();
      render();
    }

    // init
    renderStaticText();
    loadRegistry().catch(err => {
      els.grid.innerHTML=''; els.empty.hidden=false; els.empty.textContent = STR[LANG].nothing;
      console.error(err);
    });
  </script>
</body>
</html>
